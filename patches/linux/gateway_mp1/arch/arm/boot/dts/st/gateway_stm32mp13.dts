// SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause)
/*
 * Copyright (C) STMicroelectronics 2021 - All Rights Reserved
 * Author: Alexandre Torgue <alexandre.torgue@foss.st.com> for STMicroelectronics.
 */

/dts-v1/;

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/leds/common.h>
#include <dt-bindings/usb/pd.h>
#include <dt-bindings/regulator/st,stm32mp13-regulator.h>
#include "stm32mp135.dtsi"
#include "stm32mp13xf.dtsi"
#include "stm32mp13-pinctrl.dtsi"


/ {
	model = "Julitronics STM32MP13 Gateway";
	compatible = "juli,stm32mp133_gateway", "st,stm32mp135";

	aliases {
		serial0 = &usart1;
		serial3 = &usart3;
		ethernet0 = &ethernet1;
		ethernet1 = &sdio_wifi;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};

	memory@c0000000 {
		device_type = "memory";
		reg = <0xc0000000 0x20000000>;
	};

	reserved-memory {
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;

		optee@dd000000 {
			reg = <0xdd000000 0x3000000>;
			no-map;
		};
	};

	leds {
		compatible = "gpio-leds";

		led-blue {
			function = LED_FUNCTION_HEARTBEAT;
			color = <LED_COLOR_ID_BLUE>;
			gpios = <&gpioa 13 GPIO_ACTIVE_LOW>;
			linux,default-trigger = "heartbeat";
			default-state = "off";
		};
	};

    vbus_typec: vbus_typec {
		compatible = "regulator-fixed";
		regulator-name = "vbus_typec";
		regulator-min-microvolt = <4000000>;
		regulator-max-microvolt = <5000000>;
		regulator-always-on;
	};

    vddcpu: vddcpu {
		compatible = "regulator-fixed";
		regulator-name = "vddcpu";
		regulator-min-microvolt = <1200000>;
		regulator-max-microvolt = <1200000>;
		regulator-always-on;
	};

	scmi_vdd_sd: scmi_vdd_sd {
		compatible = "regulator-fixed";
		regulator-name = "scmi_vdd_sd";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		regulator-always-on;
	};

    scmi_vdd_usb: scmi_vdd_usb {
		compatible = "regulator-fixed";
		regulator-name = "scmi_vdd_usb";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		regulator-always-on;
	};

    vdd_3v3: vdd_3v3 {
		compatible = "regulator-fixed";
		regulator-name = "vdd_3v3";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		regulator-always-on;
	};

	bl_lcd: backlight {
		compatible = "pwm-backlight";
		pwms = <&pwm1 0 5000000>;
		pwm-names = "backlight";
	};

};

&crc1 {
	status = "okay";
};

&cryp {
	status = "okay";
};

&iwdg2 {
	timeout-sec = <32>;
	status = "okay";
};

&rtc {
	pinctrl-names = "default";
	pinctrl-0 = <&rtc_rsvd_pins_a>;
	status = "okay";
};

&sdmmc1 {
	pinctrl-names = "default", "opendrain", "sleep";
	pinctrl-0 = <&sdmmc1_b4_pins_a &sdmmc1_clk_pins_a>;
	pinctrl-1 = <&sdmmc1_b4_od_pins_a &sdmmc1_clk_pins_a>;
	pinctrl-2 = <&sdmmc1_b4_sleep_pins_a>;
	disable-wp;
	st,neg-edge;
	bus-width = <4>;
	vmmc-supply = <&scmi_vdd_sd>;
	vqmmc-supply = <&scmi_vdd_sd>;
	status = "okay";
};

&usart1 {
	pinctrl-names = "default", "sleep", "idle";
	pinctrl-0 = <&usart1_pins_b>;
	pinctrl-1 = <&usart1_sleep_pins_b>;
	pinctrl-2 = <&usart1_idle_pins_b>;
	status = "okay";
};

&ethernet1 {
	status = "okay";
	pinctrl-0 = <&eth1_rgmii_pins_a>;
	pinctrl-1 = <&eth1_rgmii_sleep_pins_a>;
	pinctrl-names = "default", "sleep";
	phy-mode = "rgmii";
	phy-handle = <&phy0_eth1>;
	st,eth-clk-sel;

	snps,reset-gpio = <&gpiog 12 GPIO_ACTIVE_LOW>;
	snps,reset-active-low;
	/* Reset time is 20ms, 100ms for rtl8211f */
	snps,reset-delays-us = <0 20000 100000>;

	mdio {
		#address-cells = <1>;
		#size-cells = <0>;
		compatible = "snps,dwmac-mdio";

		phy0_eth1: ethernet-phy@1 {
			compatible = "ethernet-phy-ieee802.3-c22";
			reg = <0>;
			//reset-gpios = <&gpiog 12 GPIO_ACTIVE_LOW>;
			wakeup-source;
		};
	};
};


&i2c1 {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&i2c1_pins_a>;
	pinctrl-1 = <&i2c1_sleep_pins_a>;
	i2c-scl-rising-time-ns = <96>;
	i2c-scl-falling-time-ns = <3>;
	clock-frequency = <400000>;
	status = "okay";
	/* spare dmas for other usage */
	/delete-property/dmas;
	/delete-property/dma-names;

	eeprom@50 {
		#address-cells = <1>;
   		#size-cells = <0>;
		compatible = "atmel,24c64";
		vcc-supply = <&vdd_3v3>;
		reg = <0x50>;
		eth0_addr: eth-mac-addr@0{
			reg = <0x0 0x06>;
		};
		eth1_addr: eth-mac-addr@16{
			reg = <0x10 0x06>;
		};
	};
};

/* USB C */
&i2c2 {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&i2c2_pins_a>;
	pinctrl-1 = <&i2c2_sleep_pins_a>;
	i2c-scl-rising-time-ns = <96>;
	i2c-scl-falling-time-ns = <3>;
	clock-frequency = <1000000>;
	status = "okay";
	/* spare dmas for other usage */
	/delete-property/dmas;
	/delete-property/dma-names;

	typec-portc@22 {
        compatible = "fcs,fusb302";
        reg = <0x22>;
        interrupts = <4 IRQ_TYPE_EDGE_FALLING>;
		interrupt-parent = <&gpiog>;
		pinctrl-names = "default";
		pinctrl-0 = <&fusb302_int>;
        //vbus-supply = <&vbus_typec>;

        connector {
          compatible = "usb-c-connector";
          label = "USB-C";
          power-role = "sink";
          try-power-role = "sink";
          sink-pdos = <PDO_FIXED(5000, 1000, PDO_FIXED_USB_COMM)
                       PDO_VAR(4000, 5000, 1000)
                       PDO_PPS_APDO(4000, 5000, 1000)>;
          op-sink-microwatt = <5000000>;

		  ports {
				#address-cells = <1>;
				#size-cells = <0>;

				port@0 {
					reg = <0>;
					usbc_hs: endpoint {
						remote-endpoint =
							<&usbotg_hs_ep>;
					};
				};
			};
        };
      };
};

&usbotg_hs {
	phys = <&usbphyc_port1 0>;
	phy-names = "usb2-phy";
	usb-role-switch;
	// dr_mode = "peripheral"; If not automatically
	status = "okay";
	port {
		usbotg_hs_ep: endpoint {
			remote-endpoint = <&usbc_hs>;
		};
	};
};

&usbphyc {
	status = "okay";
};

&usbphyc_port0 {
	phy-supply = <&scmi_vdd_usb>;
	st,current-boost-microamp = <1000>;
	st,decrease-hs-slew-rate;
	st,tune-hs-dc-level = <2>;
	st,enable-hs-rftime-reduction;
	st,trim-hs-current = <11>;
	st,trim-hs-impedance = <2>;
	st,tune-squelch-level = <1>;
	st,enable-hs-rx-gain-eq;
	st,no-hs-ftime-ctrl;
	st,no-lsfs-sc;
};

&usbphyc_port1 {
	phy-supply = <&scmi_vdd_usb>;
	st,current-boost-microamp = <1000>;
	st,decrease-hs-slew-rate;
	st,tune-hs-dc-level = <2>;
	st,enable-hs-rftime-reduction;
	st,trim-hs-current = <11>;
	st,trim-hs-impedance = <2>;
	st,tune-squelch-level = <1>;
	st,enable-hs-rx-gain-eq;
	st,no-hs-ftime-ctrl;
	st,no-lsfs-sc;
};

/* Wifi */
&sdmmc2 {
	pinctrl-names = "default", "opendrain", "sleep";
	pinctrl-0 = <&sdmmc2_b4_pins_a &sdmmc2_clk_pins_a>;
	pinctrl-1 = <&sdmmc2_b4_od_pins_a &sdmmc2_clk_pins_a>;
	pinctrl-2 = <&sdmmc2_b4_sleep_pins_a>;
	non-removable;
	cap-sdio-irq;
	st,neg-edge;
	bus-width = <4>;
	vmmc-supply = <&scmi_vdd_sd>;
	#address-cells = <1>;
	#size-cells = <0>;
	status = "okay";

	sdio_wifi: wifi@1 {
		reg = <1>;
       	interrupts = <13 IRQ_TYPE_EDGE_FALLING>;
		interrupt-parent = <&gpioh>;
		pinctrl-names = "default";
		pinctrl-0 = <&wifi_int>;
		interrupt-names = "host-wake";
	};
};

/* Bluetooth RTL8723bs */
&usart3 {
	pinctrl-names = "default", "sleep", "idle";
	pinctrl-0 = <&usart3_pins_b>;
	pinctrl-1 = <&usart3_sleep_pins_b>;
	pinctrl-2 = <&usart3_idle_pins_b>;
	uart-has-rtscts;
	status = "okay";

	bluetooth {
		compatible = "realtek,rtl8821cs-bt", "realtek,rtl8723bs-bt";
	};
};

/* Display */
&timers1 {
	/delete-property/dmas;
	/delete-property/dma-names;
	status = "okay";
	counter {
		status = "okay";
	};

	timer@0 {
		status = "okay";
	};
};

&pwm1 {
	/* PWM output on pin 7 of the expansion connector (CN8.7) using TIM3_CH4 func */
	pinctrl-0 = <&bl_pwm_pins>;
	pinctrl-names = "default";
	status = "okay";
};

&spi5 {
	pinctrl-names = "default";
	pinctrl-0 = <&spi5_pins_a>;
	num-cs = <1>;
	cs-gpios = <&gpiof 6 GPIO_ACTIVE_HIGH>;
	status = "okay";

	panel@0 {
		compatible = "sitronix,st7789v";
		reg = <0>;
		//pinctrl-names = "default";
		//pinctrl-0 = <&lcd_pins>;
		reset-gpios = <&gpioh 11 GPIO_ACTIVE_LOW>;
		dc-gpios = <&gpiog 5 GPIO_ACTIVE_HIGH>;
		backlight = <&bl_lcd>;
		spi-max-frequency = <15000000>;
		spi-cs-high;
		status = "disabled";
	};
};
